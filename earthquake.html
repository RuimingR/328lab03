<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <title>Earthquake List</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Including the Mapbox GL CSS file -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet">

    <!-- Including the Mapbox GL JS file -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>

    <style>
        /* CSS styles for the layout and components */
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            height: 100vh;
            flex-direction: row;
            align-items: stretch;
        }

        #side-panel {
            flex-basis: 420px;
            min-width: 300px;
            max-width: 520px;
            overflow-y: scroll;
        }

        #map {
            flex-grow: 1;
        }

        button {
            margin-bottom: 10px;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
        }

        th,
        td {
            text-align: left;
            padding: 16px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #map { min-height: 100vh; }

        table thead th { position: sticky; top: 0; background: #fff; z-index: 1; }

        caption { text-align: left; font-weight: bold; padding: 8px 0; }
    </style>
</head>

<body>
    <main id="container">
        <div id="side-panel">

            <h2>Earthquake List</h2>
            <button id="sortMagBtn" aria-label="Sort by magnitude">Sort by Magnitude</button>

            <table aria-label="Earthquake events table">
                <caption>Latest Earthquakes</caption>
                <thead>
                    <tr>
                        <th scope="col">id</th>
                        <th scope="col">magnitude</th>
                        <th scope="col">timestamp</th>
                    </tr>
                </thead>
                <tbody id="eq-tbody"></tbody>
            </table>

        </div>
        <div id="map"></div>

    </main>
    <script>
        // Define the Mapbox access token
        mapboxgl.accessToken =
            'pk.eyJ1IjoicnVpbWlyIiwiYSI6ImNtaGNzbDl0dTB1N2Uya29kOHlhOGtjZ2QifQ.gXFnHS11V3cqG3FrsqIlSA';

        // Create the map object
        let map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/satellite-v9', // style URL
            zoom: 5.5, // starting zoom
            center: [121.7740, 12.8797] // starting center
        });

        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.ScaleControl({ maxWidth: 100, unit: 'metric' }));

        async function geojsonFetch() {
            try {
                let response, earthquakes, philippines;
                response = await fetch('assets/earthquakes.geojson');
                earthquakes = await response.json();
                response = await fetch('assets/philippines.json');
                philippines = await response.json();

                // build table rows inside tbody
                const tbody = document.getElementById('eq-tbody');
                for (let i = 0; i < earthquakes.features.length; i++) {
                    const f = earthquakes.features[i];
                    const row = tbody.insertRow(-1);
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    const cell3 = row.insertCell(2);
                    const fid = f.id || (f.properties && f.properties.code) || 'N/A';
                    cell1.textContent = fid;
                    cell2.textContent = (f.properties && f.properties.mag !== undefined) ? f.properties.mag : '';
                    cell3.textContent = (f.properties && f.properties.time) ? new Date(f.properties.time).toLocaleString('en-US') : '';
                }

                function addLayers() {
                    if (!map.getSource('earthquakes')) {
                        map.addSource('earthquakes', { type: 'geojson', data: earthquakes });
                    }
                    if (!map.getLayer('earthquakes-layer')) {
                        map.addLayer({
                            id: 'earthquakes-layer',
                            type: 'circle',
                            source: 'earthquakes',
                            paint: {
                                'circle-radius': 8,
                                'circle-stroke-width': 2,
                                'circle-color': 'red',
                                'circle-stroke-color': 'white'
                            }
                        });
                    }

                    if (!map.getSource('philippines')) {
                        map.addSource('philippines', { type: 'geojson', data: philippines });
                    }
                    if (!map.getLayer('philippines-layer')) {
                        map.addLayer({
                            id: 'philippines-layer',
                            type: 'fill',
                            source: 'philippines',
                            paint: { 'fill-color': '#0080ff', 'fill-opacity': 0.5 }
                        });
                    }
                    // add an outline to improve visual clarity
                    if (!map.getLayer('philippines-outline')) {
                        map.addLayer({
                            id: 'philippines-outline',
                            type: 'line',
                            source: 'philippines',
                            paint: { 'line-color': '#004a99', 'line-width': 1.5, 'line-opacity': 0.9 }
                        });
                    }

                    // interactive popup for earthquakes
                    map.on('click', 'earthquakes-layer', (e) => {
                        const f = e.features[0];
                        const id = f.id || f.properties?.code || 'N/A';
                        const mag = f.properties?.mag ?? '';
                        const time = f.properties?.time ? new Date(f.properties.time).toLocaleString('en-US') : '';
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`<strong>${id}</strong><br>Mag: ${mag}<br>${time}`)
                            .addTo(map);
                    });
                    map.on('mouseenter', 'earthquakes-layer', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'earthquakes-layer', () => map.getCanvas().style.cursor = '');
                }

                if (map.loaded()) {
                    addLayers();
                } else {
                    map.on('load', addLayers);
                }
            } catch (err) {
                console.error('Failed to load GeoJSON:', err);
                alert('Failed to load data. Please check your assets/ paths and try again.');
            }
        }

        geojsonFetch();

        const btn = document.getElementById('sortMagBtn');
        btn.addEventListener('click', sortTable);

        function sortTable() {
            const tbody = document.getElementById('eq-tbody');
            let switching = true;
            const asc = btn.getAttribute('data-asc') === 'true';
            while (switching) {
                switching = false;
                const rows = tbody.rows;
                for (let i = 0; i < rows.length - 1; i++) {
                    let shouldSwitch = false;
                    const x = parseFloat(rows[i].getElementsByTagName('td')[1].textContent);
                    const y = parseFloat(rows[i + 1].getElementsByTagName('td')[1].textContent);
                    if ((asc && x > y) || (!asc && x < y)) {
                        shouldSwitch = true;
                        tbody.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        break;
                    }
                }
            }
            // toggle direction and update label
            btn.setAttribute('data-asc', (!asc).toString());
            btn.textContent = 'Sort by Magnitude ' + (asc ? '(desc)' : '(asc)');
        }
    </script>

</body>

</html>